<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>How Big Are Olympians?</title>
  <link href="http://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="chosen.css">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-43615902-3', 'modeanalytics.com');
      ga('send', 'pageview');

    </script>
</head>
<style>

body {
  width: 1000px;
  font: 12px sans-serif;
  font-family: Geneva;
}

.logo { float: left; margin-top: -10px; }
.social-media { float: right; text-align: right; }
.share-right { margin-top: 20px; position: absolute; right: 0px;}
.title { float: center; text-align: center; font-family: Geneva; }

.title p {
  margin: 15px; 
}

.title a {
  color: #75756F;
}

.social-icon {
  text-decoration: none;
  width: 50px;
  height: 50px;
  font-size: 2em;
  margin-left: 3px;
  margin-right: 3px;
  color: #1B3A3E;
  border-bottom: none;
}

.social-icon:hover {
  color: #AACB37;
  border-bottom: none;
  text-decoration: none;
  cursor: pointer;
  text-align: right;
}

#mode-logo {
  height: 50px;
  width: auto;
}

.story {
  width: 70%;
  float: left;
  display: table;
}

.story p {
  padding-left: 20px;
  display: table-cell;
  vertical-align: middle;
  margin: 12px;
  font-size:14px;
  font-family: Geneva;
}

footer {
  font-size: 12px;
  font-family: Geneva;
  color: #75756F;
}

footer a {
  text-decoration: none;
  font-style: italic;
  color: #75756F;
}

footer a:hover {
  text-decoration: underline;
}

.filter {
  margin: 12px;
}

.b-header {
  text-align:center;
}

.toggles {
  list-style-type:none;
  display: table;
  margin: 0 auto;
  padding-left: 50px;
}

.toggles a {
  display:block;
  width: 150px;
  color:#000;
  padding:7px 12px;
  text-decoration:none;
  text-align: center;
  font-size: 14px;
}

.toggles a:hover,
.toggles .active a{
  background: #31a354;
  color: white;
  cursor: pointer;
}

.toggles li {
  line-height:12px;
  float:left;
  background: #b7b7b7;
  margin-right:-1px;
  border:1px solid #ddd;
}

.toggles li.active {
  border:1px solid #ccc;
  background: #fed976;
  color: white;
}

.x path,
.x line {
  fill: none;
  stroke: grey;
  shape-rendering: crispEdges;
}

.y path,
.y line {
  fill: none;
  stroke: none;
  shape-rendering: crispEdges;
}

.sportHeader {
  font-family: Geneva;
  font-size: 14px;
  path: none;
}

.legend-box {
  opacity: 0.5;
}

</style>
<body>
  <div id="fb-root"></div>
  <div class="logo">
    <a href="http://blog.modeanalytics.com">
      <img id="mode-logo" src="http://mode.github.io/blog_assets/mode_logo_200px.png" />
    </a>
  </div>
  <div class="social-media">
    <a href="#" onclick="window.open('http://twitter.com/home?status=90%20years%20of%20college%20football%20recruiting,%20in%20one%20map,%20via%20@modeanalytics:%20http://bit.ly/1e71Fal','targetWindow','left=300,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=800,height=260')" class="social-icon" id="twitter"><i class="icon-twitter"></i></a>
    <a href="#" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),'facebook-share-dialog','width=626,height=436'); return false;" class="social-icon" id="facebook"><i class="icon-facebook"></i></a>
    </br>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
    </div>
  </div>
  <div class="title">
    <p style="font-size:24px">How Big Are Olympians?<p>
    <p><em style="font-size:12px"><a href="http://blog.modeanalytics.com/niney-years-of-college-football-recruiting/">Read the full post</a></em></p>
    <p><a href="https://twitter.com/modeanalytics" class="twitter-follow-button" data-show-count="false" data-lang="en">Follow @twitterapi</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></p>
  </div>
  <div class="story">
    <p>The charts below show the distribution of weights, heights, and ages in the 2014 Winter Olympic Games. Weights are shown in pounds, heights in inches, and ages in years. Note that women don't participate in Nordic Combined events, and weight data is unavailable for figure skaters and available for only a few curlers.</p>
  </div>
  
  <div class="filter">
    <ul id="position" class="toggles">
      <li class="button active" id="f0"><a>Weight</a></li>
      <li class="button" id="f1"><a>Height</a></li>
      <li class="button" id="f2"><a>Age</a></li>
    </ul>
  </div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
<script src="chosen.jquery.min.js" type="text/javascript"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>  
<script src="http://d3js.org/queue.v1.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/colorbrewer.v1.min.js"></script>
<script src="crossfilter.v1.min.js"></script>
<script>

var legend = d3.select("body").append("svg")
  .attr("width", 1000)
  .attr("height",35)
.append("g")

// Set SVG
var margin = {top: 60, right: 30, bottom: 30, left: 35},
    w = 500 - margin.left - margin.right,
    h = 200 - margin.top - margin.bottom;

var sports = ['all','alp','bai','bbs','ccy','crl','fgs','fss','hky','lge','ndc','sht','skj','skl','ssk','swb']
var sportName = ['ALL ATHLETES','Alpine Skiing','Biathlon','Bobsled','Cross Country Skiing','Curling','Figure Skating','Freestyle Skiing',
  'Hockey','Luge','Nordic Combined','Short-Track Skating','Ski Jumping','Skeleton','Speedskating','Snowboarding']
var genders = ['Female','Male']

maleText = legend.append("text")
    .attr("x",450)
    .attr("y",20)
    .attr("class","sportHeader")
    .text("Men");

femaleText = legend.append("text")
    .attr("x",530)
    .attr("y",20)
    .attr("class","sportHeader")
    .text("Women");

maleBox = legend.append("rect")
    .attr("x",420)
    .attr("y",4)
    .attr("width",20)
    .attr("height",20)
    .attr("class","legend-box")
    .attr("fill","green");

femaleBox = legend.append("rect")
     .attr("x",500)
     .attr("y",4)
     .attr("width",20)
     .attr("height",20)
     .attr("class","legend-box")
     .attr("fill","red");

sports.forEach( function(s,i) {
  
  chart = d3.select("body").append("svg")
    .attr("width", w + margin.left + margin.right)
    .attr("height", h + margin.top + margin.bottom)
  .append("g")
    .attr("transform","translate(" + margin.left + "," + margin.top + ")")
    .attr("id","chart" + i);  
})

d3.csv("athlete-list.csv", function(athletes) {

  $(".button").click(function () {
    $(".button").removeClass('active');
    $(this).addClass('active');
    
    var filter = $(this).attr("id"),
        filterNumber = +filter.slice(1,2);
    
    chartLoop(filterNumber);
  });
  
  var aBucket = 1,
      wBucket = 5,
      hBucket = 2;
      
  var cross = crossfilter(athletes),
      sport = cross.dimension( function (d) { return d.sport; }),
      gender = cross.dimension( function (d) { return d.gender; }),
      height = cross.dimension( function (d) { return d.inch; }),
      heights = height.group( function(d) { return Math.floor(d / hBucket) * hBucket; }),
      weight = cross.dimension( function (d) { return d.pound; }),
      weights = weight.group( function(d) { return Math.floor(d / wBucket) * wBucket; }),
      age = cross.dimension( function (d) { return d.age; }),
      ages = age.group( function(d) { return Math.floor(d / aBucket) * aBucket; }),
      data = [ weights, heights, ages ];

  // Height, weight, and age ranges
  var minH = 56,
      maxH = 82,
      minW = 90,
      maxW = 260,
      minA = 15,
      maxA = 60;
  
  // Figure out how many entries per variable
  var aCount = (maxA - minA)/aBucket,
      wCount = (maxW - minW)/wBucket,
      hCount = (maxH - minH)/hBucket,
      buckets = [ wCount, hCount, aCount ];
      
  // Chart dimensions
  var chartWidth = w,
      chartHeight = h,
      barPadding = 1;
  
  // Scales
  var hScale = d3.scale.linear()
        .domain([minH,maxH])
        .range([0,chartWidth]);
      
  var wScale = d3.scale.linear()
        .domain([minW,maxW])
        .range([0,chartWidth]);
      
  var aScale = d3.scale.linear()
        .domain([minA,maxA])
        .range([0,chartWidth]);
  
  scales = [ wScale, hScale, aScale ];
    
  data.forEach( function(p,i) {
    
    var filterNumber = i,
        bucket = buckets[filterNumber],
        sc = scales[filterNumber],
        dat = p;
    
    sports.forEach(function(d,i) {
    
      var chartNumber = i;
      var maxValue = dat.top(1)[0].value;
      var values = dat.top(100);
      
      y = d3.scale.linear()
          .domain([maxValue,0])
          .range([0,chartHeight]);
        
      yAxis = d3.svg.axis()
        .scale(y)
        .ticks(3)
        .orient("left");
        
      xAxis = d3.svg.axis()
        .scale(sc)
        .orient("bottom");
      
      yLine = d3.select("#chart" + chartNumber)
        .append("g")
        .attr("class","y")
        .attr("id","yline" + filterNumber)
        .call(yAxis);
          
      xGridlines = d3.select("#chart" + chartNumber)
        .selectAll(".line")
        .data(y.ticks(3))
      .enter().append("line")
        .attr("x1", 0)
        .attr("x2", chartWidth)
        .attr("class","grid")
        .attr("id",function(d) { return "grid" + chartNumber; })
        .style("stroke", "#DFE2E3")
        .attr("y1", function(d) { return y(d); })
        .attr("y2", function(d) { return y(d); });
      
      xLine = d3.select("#chart" + chartNumber)
        .append("g")
        .attr("class", "x")
        .attr("id","xline" + filterNumber)
        .attr("transform", "translate(0," + y(0) + ")")
        .attr("opacity",0)
        .call(xAxis);
        
      d3.select("#chart" + chartNumber)
          .append("text")
          .attr("x",-10)
          .attr("y",-20)
          .attr("class","sportHeader")
          .text(function() { 
            if (filterNumber == 0) {
              return sportName[chartNumber]; 
            } 
          });
      
      genders.forEach( function(g) {
        
        values.forEach(function(d,i) {
          
          bars = d3.select("#chart" + chartNumber)
            .selectAll(".bar")
            .data([0])
          .enter().append("rect")
            .attr("class","bars")
            .attr("fill",function() {
              if (g == 'Male') {return "green"; }
              else { return "red";}
            })
            .attr("opacity",0.5)
            .attr("id", function() { return "bar" + filterNumber + g + d.key; })
            .attr("width",chartWidth/bucket - barPadding)
            .attr("x",function() { return sc(d.key); })
        })
      })
    })
  })
  
  chartLoop(0);
  
  function chartLoop(filterNumber) {
    
    d3.selectAll(".x")
      .transition()
      .attr("opacity",0)
      .duration(1000);
    
    d3.selectAll(".y")
      .transition()
      .attr("opacity",0)
      .duration(1000);
      
    d3.selectAll(".grid")
      .transition()
      .attr("opacity",0)
      .duration(1000);
    
    d3.selectAll(".bars")
      .transition()
      .attr("height",0)
      .attr("y",function() { return chartHeight; })
      .duration(1000);
    
    sports.forEach( function(s,i) {
      
      var chartNumber = i;
      
      if (s == 'all') {
        sportFilter = sport.filter(null)
      } else {
        filter = sport.filterExact(s)
      }
      
      var maxA = findMax(filterNumber);
      
      genders.forEach (function (g) {
        
        genderFilter = gender.filterExact(g)
        drawChart(filterNumber,chartNumber,g,maxA);

      })
    })
  }
  
  function findMax(filterNumber) {
    
    m = 3;
    
    genders.forEach(function(g) {
      genderFilter = gender.filterExact(g)
      dat = data[filterNumber];
      
      if (dat.top(1)[0].key == 0) {
        max = dat.top(2)[1].value;
      } else {
        max = dat.top(1)[0].value;
      }
      
      if (max > m) { m = max; }
      
    })
    
    gender.filter(null)
    
    return m;
  }
  
  function drawChart(filterNumber,chartNumber,gender,axisMax) {
      
      bucket = buckets[filterNumber],
      sc = scales[filterNumber],
      dat = data[filterNumber];
      
      maxY = axisMax;
      
      y.domain([maxY,0]);
      xAxis.scale(sc);
      yAxis.scale(y);
      
      d3.selectAll("#chart" + chartNumber)
        .select("#xline" + filterNumber)
        .transition()
        .call(xAxis)
        .attr("opacity",1)
        .duration(1000);
      
      d3.selectAll("#chart" + chartNumber)
        .select("#yline" + filterNumber)
        .transition()
        .call(yAxis)
        .attr("opacity",1)
        .duration(1000);
        
      d3.selectAll("#grid" + chartNumber)
        .data(y.ticks(3))
        .transition()
        .attr("opacity",.7)
        .attr("y1", function(d) { return y(d); })
        .attr("y2", function(d) { return y(d); })
        .duration(1000);
      
      var l = dat.top(100).length;
      var obj = dat.top(100);
      
      for (var i=0;i<l;i++) {
        var val = obj[i].value,
            key = obj[i].key;
      
        d3.selectAll("#chart" + chartNumber)
          .select("#bar" + filterNumber + gender + key)
          .transition()
          .attr("height",function() { 
            if (gender == 'Female' & key >= 200) {
              return 0;
            } else {
              return chartHeight - y(val);
            }
          })
          .attr("y",function() { return y(val); })
          .duration(1000);
      }
  }
  
})

</script>
<hr>
</body>
<footer>  
  <p>Source: <a href="http://www.sochi2014.com/en">Sochi2014</a>.<p>
  </footer> 